<!DOCTYPE html>
<html lang="en">
<head template-fn="import:package.json">
    <meta charset="utf-8" />
    <meta name="author" content="@{[author.twitter]}" />
    <meta name="description" content="Documentation for {[title]}. {[description]}" />
    <meta name="viewport" content="width=device-width" />

    <title>{[title]}</title>

    <script>
    document.documentElement.className = 'js';
    window.DEBUG = true;
    </script>

    <link rel="stylesheet" href="../bolt/css/html.css" />
	<link rel="stylesheet" href="../bolt/css/svg.css" />
	<link rel="stylesheet" href="../bolt/css/body.css" />
	<link rel="stylesheet" href="../bolt/css/input.css" />
	<link rel="stylesheet" href="../bolt/css/label.css" />
	<link rel="stylesheet" href="../bolt/css/block.css" />
	<link rel="stylesheet" href="../bolt/css/index.css" />
	<link rel="stylesheet" href="../bolt/css/layer.css" />
	<link rel="stylesheet" href="../bolt/css/button.css" />
	<link rel="stylesheet" href="../bolt/css/thumb.css" />
	<link rel="stylesheet" href="../bolt/css/type.css" />
	<link rel="stylesheet" href="../bolt/css/text.css" />
	<link rel="stylesheet" href="../bolt/css/color.css" />
	<link rel="stylesheet" href="../bolt/css/modifiers.css" />
    <link rel="stylesheet" href="../bolt/components/grid/grid.css" />
	<link rel="stylesheet" href="../bolt/components/dialog/dialog.css" />

    <link rel="stylesheet" href="components/sparky/midi/style.css" />
    <link rel="stylesheet" href="components/sparky/fader/style.css" />

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        html,
        body {
            background-color: #65757b;
        }

        body {
            display: grid;
            grid-gap: 0;
            grid-template-areas:
                'inputs nodes nodes nodes outputs'
                'inputs sequencer sequencer sequencer outputs'
                'controls controls controls controls controls';
            grid-template-columns: 0 1fr 1fr 1fr 0;
            grid-template-rows: 1fr max-content 3.75rem;
            height: 100vh;
        }

        body > .inputs-block {
            grid-area: inputs;
        }

        body > .outputs-block {
            grid-area: outputs;
        }

        body > .nodes-block {
            grid-area: nodes;
            min-height: 0;
            max-height: 100vh;
        }

        body > .events-block {
            grid-area: sequencer;
            min-height: calc(33.333333vh - 3.75rem);
            color: white;
            background-color: #252c2d;
        }

        body > .bar-block {
            grid-area: controls;
        }

        .nodes-block {
            margin: 0;
            display: grid;
            padding: 1.3125rem;
            grid-gap: 0.75rem;
            grid-template-columns: repeat(auto-fit, minmax(20rem, 1fr));
            overflow: auto;
        }

        .nodes-block > .label-block {
            position: absolute;
            top: 0.375rem;
            left: 1.875rem;
            margin: 0;
            text-transform: uppercase;
            font-size: 0.5625rem;
        }

        .node-block {
            padding: 9px;
            margin: 0;
            height: min-content;
            background-color: #dfe4ec;
            border-radius: 0.25rem;
        }

        .bar-block {
            display: flex;
            margin: 0;
            background-color: #2c3a3e;
        }

        .sources-block {
            display: flex;
            flex-wrap: none;

        }

        .sources-block > * + * {
            margin-left: 9px;
        }

        .envelopes-block {
            display: flex;
            flex-wrap: none;
        }

        .envelopes-block > * + * {
            margin-left: 9px;
        }

        th, td { text-align: left; }
    </style>

    <template id="fader-control-template">
        <link rel="stylesheet" href="components/controls/fader-control.css" />
        <label for="input"><slot>Value</slot></label>
        <div class="tick" fn="get:ticks each" :style="left: calc(0.5rem + (100% - 1.125rem) * {[inputValue]});">
            <input class="masked" style="position: absolute; top: -3000px;" type="radio" name="tick" id="tick-{[value]}" value="{[inputValue]}"/>
            <label for="tick-{[value]}">{[outputValue]}</label>
        </div>
        <input type="range" id="input" value="{[inputValue]}" min="0" max="1" step="any" />
        <output>{[prefix]}{[outputValue]}<abbr>{[unit]}</abbr></output>
        <slot name="plugs"></slot>
    </template>

    <template id="node-input" fn="get:data">
        {[.]}
    </template>

    <template id="node-/soundstage/nodes/tone-synth.js" fn="get:data">
        <fader-control :value="{[gain]}" unit="dB" min="-60dB" max="1" transform="logarithmic-zero"></fader-control>
        <div class="sources-block block">
            <div fn="get:sources each">
                <select value="{[type]}">
                    <option value="triangle">Triangle</option>
                    <option value="square">Square</option>
                    <option value="sine">Sine</option>
                </select>
                <fader-control :value="{[detune]}" min="-1200" max="1200" transform="linear" ticks="-1200 0 1200" unit="semitones"></fader-control>
                <fader-control :value="{[pan]}" unit="lcr" min="-1" max="1" transform="linear" ticks="-1 0 1"></fader-control>
                <fader-control :value="{[mix]}" unit="dB" min="-48dB" max="1" transform="logarithmic-zero"></fader-control>
            </div>
        </div>

        <h3>Gain envelope</h3>

        <div class="envelopes-block block">
            <div fn="get:gainEnvelope entries each">
                <h3>{[0]}</h3>
                <ul>
                    <li fn="get:1 each">{[.]}</li>
                </ul>
            </div>
        </div>

        <h3>Filter envelope</h3>

        <div class="envelopes-block block">
            <div fn="get:frequencyEnvelope entries each">
                <h3>{[0]}</h3>
                <ul>
                    <li fn="get:1 each">{[.]}</li>
                </ul>
            </div>
        </div>

        <fader-control :value="{[pitch]}" unit="semitones" min="-2" max="2"></fader-control>
        <fader-control :value="{[frequency]}" unit="Hz" min="20" max="16000" transform="logarithmic"></fader-control>
        <fader-control :value="{[Q]}" unit="Q" min="0.2" max="20"></fader-control>
        <fader-control :value="{[output]}" unit="dB" min="-48dB" max="1" transform="logarithmic-zero"></fader-control>
    </template>

    <template id="node-/soundstage/nodes/flanger.js" fn="get:data">
        <fader-control :value="{[gain]}" unit="dB" min="-48dB" max="1" transform="logarithmic-zero">Gain</fader-control>
        <fader-control :value="{[delay]}" unit="s" min="0" max="2" transform="quadratic">Delay</fader-control>
        <fader-control :value="{[frequency]}" unit="Hz" min="0.083333333" max="90" transform="logarithmic-zero">LFO Frequency</fader-control>
        <fader-control :value="{[depth]}" unit="s" min="0" max="0.2" transform="linear" prefix="Â±">LFO Depth</fader-control>
        <fader-control :value="{[feedback]}" unit="dB" min="-36dB" max="1" transform="logarithmic-zero">Feedback</fader-control>
        <fader-control :value="{[wet]}" unit="dB" min="-48dB" max="1" transform="logarithmic-zero">Wet</fader-control>
        <fader-control :value="{[dry]}" unit="dB" min="-48dB" max="1" transform="logarithmic-zero">Dry</fader-control>
    </template>

    <template id="node-compressor" fn="get:data">
        <fader-control :value="{[threshold]}" unit="" min="-60" max="0" transform="linear"></fader-control>
        <fader-control :value="{[ratio]}" unit="" min="1" max="20" transform="cubic"></fader-control>
        <fader-control :value="{[knee]}" unit="" min="0" max="40" transform="cubic"></fader-control>
        <fader-control :value="{[attack]}" unit="s" min="0" max="1" transform="quadratic"></fader-control>
        <fader-control :value="{[release]}" unit="s" min="0" max="1" transform="quadratic"></fader-control>
    </template>

    <template id="node-output" fn="get:data">
        {[name]} {[channels]}
        <!--select value="{[channels|join:',']}">
            <options value="1,2">1-2</option>
            <options value="1">1</option>
            <options value="2">2</option>
        </select-->
    </template>

    <template id="node-mix" fn="get:data">
        <fader-control :value="{[pan]}" unit="lcr" min="-1" max="1" transform="linear,[-1,0,1]"></fader-control>
        <fader-control :value="{[gain]}" unit="dB" min="-60dB" max="1" transform="logarithmic-zero" ticks="0 0.0009765625 0.001953125 0.00390625 0.0078125 0.015625 0.03125 0.0625 0.125 0.25 0.5 1"></fader-control></fader-control>
    </template>

    <template id="node-/soundstage/nodes/metronome.js" fn="get:data">
        <p>Tick {[tick]}</p>
        <p>Tick {[tock]}</p>
        <ul>
            <li fn="get:events each">{[.]}</li>
        </ul>
        <fader-control :value="{[gain]}" unit="dB" min="-60dB" max="1" transform="logarithmic-zero"></fader-control>
    </template>

    <template id="source-device-midi">
        MIDI {[.]}
    </template>

    <template id="source-device-keys">
        KEYS {[.]}
    </template>
</head>

<body>
    <div class="bar-block block">
        <h1 class="logo-thumb thumb"><pre>label: {[label]}</pre></h1>

        <template is="sparky" fn="soundstage">
            <template include="components/sparky/transport/template.html#transport"></template>
            <a fn="midi-status" href="#">MIDI</a>
        </template>
    </div>

    <template is="sparky" fn="soundstage">
        <div class="inputs-block block" fn="get:'nodes[type=input]'">
            <pre>{[id]}</pre>
        </div>

        <div class="outputs-block block" fn="get:'nodes[type=output]'">
            <pre>{[id]}</pre>
        </div>

        <div class="nodes-block block">
            <h2 class="label-block block">Nodes</h2>
            <div class="node-block block" fn="get:nodes each">
                <pre>{[id]} <small>{[type]}</small></pre>
                <template include="node-{[type]}">
                    <template fn="get:gain"></template>
                </template>
            </div>

            <template fn="get:connections">
                <div class="connections-block block">
                    <h2>Connections</h2>
                    <pre fn="each">{[.]}</pre>
                </div>
            </template>

            <!--template fn="get:controls">
                <div class="controls-block block">
                    <h2>Controls</h2>
                    <div fn="each">
                        <pre>{[.]}</pre>
                        <div fn="get:source" include="source-device-{[device]}"></div>
                        <div fn="get:data">
                            {[.]} {[latencyCompensation]}
                            <label>Min</label>
                            <input type="number" min="" max="" sparky-value={[min]} />
                            <label>Max</label>
                            <input type="number" min="" max="" sparky-value={[max]} />
                            <label>Transform</label>
                            <select sparky-value="{[transform]}">
                                <option value="linear">Linear</option>
                                <option value="logarithmic">Logarithmic</option>
                                <option value="logarithmic-zero">Linear 0-min Logarithmic min-max</option>
                                <option value="cubic">Cubic</option>
                                <option value="toggle">Toggle</option>
                                <option value="switch">Switch</option>
                                <option value="continuous">Continuous</option>
                            </select>
                            <label>Latency compensation</label>
                            <input type="checkbox" sparky-value={[latencyCompensation]} />
                        </div>
                    </div>
                </div>
            </template-->
        </div>

        <!--div class="events-block block" fn="get:events">
            <h2>Events</h2>
            <pre>
            <table>
                <thead>
                    <tr fn="each">
                        <th>Beat</th>
                        <th>Type</th>
                        <th>Name</th>
                        <th>Data</th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr fn="each">
                        <td>{[0]}</td>
                        <td>{[1]}</td>
                        <td>{[2]}</td>
                        <td>{[3]}</td>
                        <td>{[4]}</td>
                        <td>{[5]}</td>
                        <td>{[6]}</td>
                    </tr>
                </tbody>
            </table>
            </pre>
        </div-->

        <!--div class="sequences-block block" fn="get:sequences">
            <h2>Sequences</h2>
            <div fn="each">
                {[.]}
            </div>
        </div-->
    </template>

    <!-- Tests -->
    <script type="module">
    import './components/sparky/fader/fns.js';
    import './components/sparky/midi/fns.js';

    import * as Fn from '../fn/fn.js';
    window.Fn = Fn;

    import { Stream } from '../fn/fn.js';
    window.Stream = Stream;

    import Timer from './modules/timer.js';
    window.Timer = Timer;

    import Soundstage from './soundstage.js';
    window.Soundstage = Soundstage;

    import Sparky, { functions, notify, mountConfig } from '../sparky/sparky.js';
    window.Sparky = Sparky;

    import context from './modules/context.js';

    const stagePromise = Promise.all([
        context
        .audioWorklet
        .addModule('./nodes/signal.worklet.js'),

        context
        .audioWorklet
        .addModule('./nodes/recorder.worklet.js')
    ])
    .then(function() {

        //import './nodes/tone.test.js';
        //import './test/tone-voice.test.js';
        //import './test/tone-synth.test.js';

        return (window.stage = new Soundstage({
            label: "Guitar",

            nodes: [{
                id:    'input',
                type:  'input',
                label: 'Input',
                data:  {}
            }, /*{
                id:    'synth',
                type:  '/soundstage/nodes/tone-synth.js',
                label: 'Tone Synth',
                data: {
                    sources: [
                        { type: 'triangle', detune: -1192, mix: 0.5, pan: -0.8 },
                        { type: 'sine',   detune: 0, mix: 0.25, pan: 0.8 },
                        { type: 'square', detune: -1208,     mix: 0.125, pan: 0.2 }
                    ],

                    gainEnvelope: {
                        attack: [
                            [0, 'step', 0],
                            [0.01, 'linear', 1]
                        ],

                        release: [
                            [0, 'target', 0, 0.1]
                        ]
                    },

                    frequencyEnvelope: {
                        attack: [
                            [0,    "step",   0],
                            [0.06, "linear", 1000],
                            [5,    "exponential", 200],
                        ],

                        release: [
                            [0,  "target", 0, 0.02]
                        ]
                    },

                    type: 'lowpass',
                    frequency: 100,
                    frequencyFromVelocity: 0.5,

                    Q: 5,

                    output: 0.1
                }
            }, {
                id:    'compressor',
                type:  'compressor',
                label: 'Compressor',
                data: {
                    attack:    0.028,
                    release:   0.08,
                	knee:      12,
                	ratio:     2.5,
                    threshold: -28
                }
            }, */{
                id:    'flanger',
                type:  '/soundstage/nodes/flanger.js',
                label: 'Flanger',
                data: {
                    delay:     0.008,
                	frequency: 0.333333,
                	depth:     0.004,
                	feedback:  0.1,
                    dry:       0,
                    wet:       0.5
                }
            }, /*{
                id:    'delay-send',
                type:  'mix',
                label: 'Delay feed',
                data: {
                    pan: 0,
                    gain: 0.125,
                    mute: true
                }
            }, {
                id:    'delay',
                type:  '/soundstage/nodes/flanger.js',
                label: 'Delay',
                data: {
                    delay:     0.26,
                	frequency: 0.1,
                	depth:     0.02,
                	feedback:  0.4,
                    dry:       1,
                    wet:       0.04
                }
            }, {
                id:    'metronome',
                type:  '/soundstage/nodes/metronome.js',
                label: 'Metronome',
                data: {}
            },*/ {
                id:    'output',
                type:  'output',
                label: 'Output',
                data: {}
            }],

            connections: [
                { source: 'input',      target: 'flanger' },
                //{ source: 'compressor', target: 'flanger' },
                //{ source: 'flanger',    target: 'delay-send' },
                { source: 'flanger',    target: 'output' },
                //{ source: 'delay-send', target: 'delay' },
                //{ source: 'delay',      target: 'output' },
                //{ source: 'synth',      target: 'output' },
                //{ source: 'metronome',  target: 'output' }
            ],

            controls: [{
                source: {
                    device: 'keys',
                    key: 'a'
                },

                target: 'delay-send',

                data: {
                    transform: 'linear',
                    type:   'param',
                    name:   'gain',
                    min:    0,
                    max:    1
                }
            }, {
                source: {
                    device: 'midi',
                    channel: 1,
                    type:    'note'
                },
                transform: 'linear',
                type:  'note',
                min:   0,
                max:   1,
                target: 'synth'
            }, {
                source: {
                    device: 'midi',
                    channel: 1,
                    type:    'pitch'
                },
                transform: 'linear',
                type:  'pitch',
                min:   0,
                max:   1,
                target: 'synth'
            }],

            sequences: [{
                id: 'test',
                events: [
                    [0, 'note', 49, 0.5, 1]
                ]
            }],

            events: [
                [0, 'sequence', 'test', 'synth', 2]
            ]
        }, {
            notify: notify
        }));
    });

    functions.soundstage = function(node, scope, params) {
        const output = Stream.of();

        stagePromise.then(function(stage) {
            output.push(stage);
        });

        return output;
    };

    functions.set = function(node, scopes, params) {
        return scopes.tap((object) => {
            object[params[0]] = params[1];
        });
    };

    // Add custom elements to Sparky's mount config
    Object.assign(mountConfig, {
        'fader-control': {
            attributes: [],
            booleans: ['disabled'],
            value: 'number'
        }
    });
    </script>

    <script type="module" src="components/controls/fader-control.js"></script>
</body>
